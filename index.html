<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="author" content="niko" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
	<title>Harry Plotter</title>
	<link href='harry.css' rel='stylesheet' type='text/css'>
	<script src="harry.js"></script>
	<script src="miniko.js"></script>
	<script src="minitools.js"></script>
</head>
<body>

	<canvas id="headanim"></canvas>
	<h1>Harry Plotter v1.0</h1>
	<menu>
		<button id="butreadme">Read me</button><button id="butgenerator">Generator</button><button id="butpresets">Presets</button>
	</menu>

	<div id="forkme">Fork me on <img src="octocat-icon.png"/></div>

	<content id="readme">
		<pre id="md"></pre>
	</content>

	<content id="generator">
		<div id="rendgen">
			<div id="harrygen">
				<h2>Canvas</h2>
				<div id="plot"></div>
			</div>
			<div id="jsgen">
				<h2>Javascript</h2>
				<div id="js"><pre id="jsout"></pre></div>
			</div>
		</div>
		<div id="formgen" class="center">
			<form id="fgen">
				<hr/>

				<h2>Title</h2>

				<div class="formcol">
					<label for="titletext">text</label><input type="text" id="titletext" /><br/>
					<label for="titlefont">font</label><input type="text" id="titlefont" class="font" placeholder='bold 12px "Sans Serif"' /><br/>
				</div>
				<div class="formcol">
					<label for="titlecolor">color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="titlecolor" value="" class="color"/><input type="color" id="ititlecolor"/><br/>
					<label for="titleshadow">shadow</label><input type="text" placeholder="x,y,blur,color" id="titleshadow" value="" />
				</div>
				<div class="formcol">
					<label for="titlex">x</label><input type="text" id="titlex" class="int" />px<br/>
					<label for="titley">y</label><input type="text" id="titley" class="int" />px<br/>
					<label for="titlez">z</label><select id="titlez">
						<option value="">default</option>
						<option value="top">top</option>
						<option value="background">background</option>
					</select><br/>
				</div>
				<hr/>

				<h2>Datasets</h2>

				<table>
					<tr><th></th><th>values</th><th>title</th><th>color</th></tr>
					<tr>
						<td>#1</td>
						<td><input type="text" id="data0" placeholder="y1,y2,y3... or L1:y1,L2:y2,..." value="2000-01-01:1,2000-01-02:2,2000-01-03:4,2000-01-04:8,2000-01-05:16,2000-01-06:32,2000-01-07:64,2000-01-08:32,2000-01-09:16,2000-01-10:8,2000-01-11:4,2000-01-12:2,2000-01-13:1" class="data" /><input id="butrnd0" type="button" class="rnd" value="random" target="data0" /></td>
						<td><input type="text" id="title0" value="" /></td>
						<td><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="color0" value="" class="color"/><input type="color" id="icolor0"/></td>
					</tr>
					<tr>
						<td>#2</td>
						<td><input type="text" id="data1" placeholder="y1,y2,y3... or L1:y1,L2:y2,..." value="" class="data" /><input id="butrnd1" type="button" class="rnd" value="random" target="data1" /></td>
						<td><input type="text" id="title1" value="" /></td>
						<td><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="color1" value="" class="color"/><input type="color" id="icolor1"/></td>
					</tr>
					<tr>
						<td>#3</td>
						<td><input type="text" id="data2" placeholder="y1,y2,y3... or L1:y1,L2:y2,..." value="" class="data" /><input id="butrnd2" type="button" class="rnd" value="random" target="data2" /></td>
						<td><input type="text" id="title2" value="" /></td>
						<td><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="color2" value="" class="color"/><input type="color" id="icolor2"/></td>
					</tr>
				</table>

				<hr/>

				<h2>Rendering</h2>

				<div class="formcol">
					<label for="mode">mode</label><select id="mode">
						<option value="">auto</option>
						<option>line</option>
						<option>line:stack</option>
						<option>pie</option>
						<option>pie:donut</option>
						<option>chart</option>
						<option>chart:stack</option>
						<option>chart:vertical</option>
						<option>chart:vertical:stack</option>
						<option>curve</option>
						<option>curve:stack</option>
					</select><br/>
					<label for="anim">animation</label><select title="animation duration in seconds" id="anim">
						<option value="">0 - disabled</option>
						<option value="1">1 - speed</option>
						<option value="2">2 - smooth</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option value="10">10 - slowmotion</option>
					</select>s<br/>
					<label for="width">width</label><input type="text" id="width" class="int" value="" placeholder="300"/>px<br/>
					<label for="height">height</label><input type="text" id="height" class="int" value="" placeholder="80"/>px<br/>
					<label for="margins">margins</label><input type="text" id="margins" placeholder="top,right,bottom,left" value="" />px<br/>
				</div>
				<div class="formcol">
					<label for="scaletop">scale top</label><select id="scaletop">
						<option value="">max value</option>
						<option value="auto">rounded max value</option>
					</select><br/>
					<label for="scalebottom">scale bottom</label><select id="scalebottom">
						<option value="">0</option>
						<option value="auto">min value</option>
					</select><br/>
					<label for="background">background</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="background" value="" class="color"/><input type="color" id="ibackground"/><br/>
					<label for="radiuspoint">radiuspoint</label><select title="line or curve mode" id="radiuspoint">
						<option value="">default</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>10</option>
						<option>15</option>
						<option>20</option>
						<option>40</option>
					</select>px<br/>
					<label for="barspace">barspace</label><select id="barspace" title="chart mode only">
						<option value="">auto</option>
						<option>0</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>10</option>
						<option>15</option>
						<option>20</option>
					</select>px
				</div>
				<div class="formcol">
					<label for="fill">fill</label><select id="fill">
						<option value="">solid</option>
						<option>none</option>
						<option>light</option>
						<option>dark</option>
						<option>vertical</option>
						<option>horizontal</option>
						<option>radial</option>
					</select><br/>
					<label for="opacity">opacity</label><select id="opacity">
						<option value="">auto</option>
						<option value="0.1">0.1 - transparent</option>
						<option>0.2</option>
						<option>0.3</option>
						<option>0.4</option>
						<option value="0.5">0.5 - semi transparent</option>
						<option>0.6</option>
						<option>0.7</option>
						<option>0.8</option>
						<option>0.9</option>
						<option value="1">1.0 - opaque</option>
					</select><br/>
					<label for="linewidth">linewidth</label><select id="linewidth">
						<option value="">default</option>
						<option>0</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>8</option>
						<option>9</option>
						<option>10</option>
					</select>px<br/>
					<label for="linejoin">linejoin</label><select title="for line or chart mode" id="linejoin">
						<option value="">default</option>
						<option>round</option>
						<option>miter</option>
						<option>bevel</option>
					</select><br/>
				</div>
				<hr/>

				<h2>Grid</h2>

				<div class="formcol">
					<label for="gridx">x</label><select id="gridx">
						<option value="">default</option>
						<option>none</option>
						<option>all</option>
						<option>left</option>
						<option>right</option>
						<option>left+right</option>
						<option value="2">1/2</option>
						<option value="3">1/3</option>
						<option value="4">1/4</option>
						<option value="5">1/5</option>
						<option value="10">1/10</option>
					</select><br/>
					<label for="gridy">y</label><input type="text" id="gridy" placeholder="none or %,%,%..." value="" /><br/>
				</div>
				<div class="formcol">
					<label for="gridlinewidth">linewidth</label><select id="gridlinewidth">
						<option value="">default</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>8</option>
						<option>9</option>
						<option>10</option>
					</select>px<br/>
				</div>
				<div class="formcol">
					<label for="gridcolor">color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="gridcolor" value="" class="color"/><input type="color" id="igridcolor"/><br/>
				</div>
				<hr/>

				<h2>Labels</h2>

				<div class="formcol">
					<label for="labelfont">font</label><input type="text" id="labelfont" class="font" value='' placeholder='normal 9px "Sans Serif"'/><br/>
					<label for="labelcolor">color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="labelcolor" value="" class="color"/><input type="color" id="ilabelcolor"/><br/>
					<label for="labelshadow">shadow</label><input type="text" placeholder="x,y,blur,color" id="labelshadow" value="" />
				</div>
				<div class="formcol">
					<label for="labely">y axis labels</label><input type="text" id="labely" placeholder="%,%,%..." value="" title="show veritcals labels for each labels.y percent"/><br/>
					<label for="labelypos">y axis position</label><select id="labelypos">
						<option value="">auto</option>
						<option>left</option>
						<option>right</option>
						<option>left+right</option>
					</select><br/>
					<label for="labelx">x axis labels</label><select id="labelx">
						<option value="">none</option>
						<option value="auto">auto</option>
						<option value="1">all</option>
						<option value="2">1/2</option>
						<option value="3">1/3</option>
						<option value="4">1/4</option>
						<option value="5">1/5</option>
						<option value="10">1/10</option>
						<option value="20">1/20</option>
					</select><br/>
				</div>
				<div class="formcol">
					<label for="labelmarks">marks</label><select id="labelmarks">
						<option value="">none</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
					</select>px<br/>
				</div>
				<hr/>

				<h2>Legends</h2>

				<div class="formcol">
					<label for="legends">enabled</label><input type="checkbox" id="legends" checked="checked" /><br/>
					<label for="leglayout">layout</label><select id="leglayout">
						<option value="">default</option>
						<option value="h">horizontal</option>
						<option value="v">vertical</option>
					</select></br>
					<label for="legx">x</label><input type="text" id="legx" placeholder="int" value="" /><br/>
					<label for="legy">y</label><input type="text" id="legy" placeholder="int" value="" /><br/>
				</div>
				<div class="formcol">
					<label for="legfont">font</label><input type="text" id="legfont" placeholder='normal 10px "Sans Serif"' class="font" value="" /><br/>
					<label for="legcolor">color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="legcolor" value="" alt="legend border color" class="color"/><input type="color" id="ilegcolor"/><br/>
					<label for="legshadow">text shadow</label><input type="text" placeholder="x,y,blur,color" id="legshadow" value="" /><br/>
					<label for="legborder">border</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="legborder" value="" alt="legend border color"/><br/>
				</div>
				<div class="formcol">
					<label for="legbackground">background</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="legbackground" value="" class="color"/><input type="color" id="ilegbackground"/><br/>
					<label for="legborder2">color box border</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="legborder2" value="" alt="color box border color"/><br/>
					<label for="legshadowbox">box shadow</label><input type="text" placeholder="x,y,blur,color" id="legshadowbox" value="" /><br/>
				</div>
				<hr/>

				<h2>MouseOver</h2>

				<div class="formcol">
					<label for="mouseover">enabled</label><input type="checkbox" id="mouseover" checked="checked" /><br/>
					<label for="moradius">spot radius</label><input type="text" id="moradius" class="int" value="" placeholder="5"/>px<br/>
					<label for="molinewidth">spot linewidth</label><select id="molinewidth">
						<option value="">default</option>
						<option value="0">filled</option>
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>4</option>
						<option>5</option>
						<option>6</option>
						<option>7</option>
						<option>8</option>
						<option>9</option>
						<option>10</option>
					</select><br/>
					<label for="mocircle">spot color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="mocircle" value="" class="color"/><input type="color" id="imocircle"/><br/>
					<label for="moborder2">spot border</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="moborder2" class="color" value="" /><input type="color" id="imoborder2"/><br/>
					<label for="mobullet">bullet color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="mobullet" value="" class="color"/><input type="color" id="imobullet"/><br/>
					<label for="moshadowbox">bullet shadow</label><input type="text" placeholder="x,y,blur,color" id="moshadowbox" value="" /><br/>
					<label for="moborder">bullet border</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="moborder" value="" class="color"/><input type="color" id="imoborder"/><br/>
				</div>
				<div class="formcol">
					<label for="motext">text</label><input type="text" id="motext" title="%l=label %v=value %n=index %p=pct(pie only) %t=dataset" placeholder="%v" value=""/><br/>
					<label for="mofont">text font</label><input type="text" id="mofont" placeholder='normal 10px "Sans Serif"' class="font" value="" /><br/>
					<label for="mocolor">text color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="mocolor" value="" class="color"/><input type="color" id="imocolor"/><br/>
					<label for="moshadow">text shadow</label><input type="text" placeholder="x,y,blur,color" id="moshadow" value="" /><br/>
					<label for="mosort">sorted</label><input type="checkbox" id="mosort" /><br/>
					<label for="moaxis">axis</label><select id="moaxis">
						<option value="">none</option>
						<option>xy</option>
						<option>x</option>
						<option>y</option>
					</select><br/>
				</div>
				<div class="formcol">
					<label for="headtext">header text</label><input type="text" id="headtext" title="%l=label %v=value %n=index %p=pct(pie only) %t=dataset" placeholder="" value=""/><br/>
					<label for="headfont">header font</label><input type="text" id="headfont" placeholder='normal 10px "Sans Serif"' class="font" value="" /><br/>
					<label for="headcolor">header color</label><input type="text" placeholder="#rrggbb or rgba(r,g,b,a)" id="headcolor" value="" class="color"/><input type="color" id="iheadcolor"/><br/>
					<label for="headshadow">header shadow</label><input type="text" placeholder="x,y,blur,color" id="headshadow" value="" /><br/>
				</div>

				<hr/>

				<div class="footer">
					<input id="butreset" type="button" value="reset" />
				</div>
			</form>
		</div>
	</content>

	<content id="presets">
		<div id="samples">
		</div>
		<header>more to come ...</header>
		Do not hesitate to submit your setup by forking and send me a pull request on my gh-pages.
		Presets are in the file presets.js
	</content>

	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-27845368-6']);
		_gaq.push(['_trackPageview']);
		(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>

	<script type="text/javascript">
		"use strict";
		var
		PRESETS,
		MAXDATA=16,
		TABS=['readme','generator','presets'],

		//MARKDOWN

		md=(function(){
			var
			conv=function(s){
				return s
					.replace(/</g,'&lt;')
					.replace(/>/g,'&gt;')
					.replace(/\[([^\]]+)\]\((http[^\)]+)\)/,'<a href="$2">$1</a>')
					.replace(/\s\s+$/,"<br/>")
					.replace('\t','  ')
				;
			},
			colorize=function(s){
				return s
					.replace(/(\/\/.+$)/,'<span class="comment">$1</span>')
				;
			};
			return {
				html: function(md,start){
					var l=md.split(/[\n\r]/),b='',i=(start||0),s;
					while(i<l.length) {
						//list
						if(/^\s+\-\s/.test(l[i])) {
							b+="<ul>";
							while(i<l.length && /^\s+\-\s(.+)/.test(l[i])) {
								b+="<li>"+conv(RegExp.$1)+"</li>";
								i++;
							}
							b+="</ul>";
						//code
						} else if(/^[\s\s|\t]/.test(l[i])) {
							b+="<pre>";
							while(i<l.length && (l[i]=="" || /^[\s\s|\t](.*)$/.test(l[i])))
								b+= l[i++]=="" ? "\n" : colorize(conv(RegExp.$1))+"\n";
							b+="</pre>";
						//subtitle
						} else if(/^\*\*(.+)\*\*$/.test(l[i])) {
							b+="<h2>"+conv(RegExp.$1)+"</h2>";
							i++;
						} else {
							b+=conv(l[i++]);
						}
					}
					return b;
				}
			};
		})(),

		//JSON

		js=(function(){
			var newline=function(i){
				return "\n"+("                                      ".substr(0,i*3));
			};
			return {
				encode: function(o,quote) { /*ignore functions*/
					if(o==undefined) return 'null';
					var lines=[], isarray=(o.constructor==Array),k,v,s,qk;
					for(k in o) {
						v=o[k];
						qk=quote||/[\: ]/.test(k)?'"'+k+'"':k;
						if(typeof v=="object") {
							if(isarray) lines.push(js.encode(v,quote));
							else lines.push(qk+':'+js.encode(v,quote));
						} else if(typeof v!="function") {
							s=isarray?"":qk+':';
							if(typeof v=="number") s+=v.toString(10);
							else if(v===false) s+='false';
							else if(v===true) s+='true';
							else s+='"'+(v || "").replace(/"/g,"\\\"").replace(/\n|\r/g,' ')+'"';
							lines.push(s);
						}
					}
					return (isarray) ? "["+lines.join(",")+"]" : "{"+lines.join(",")+"}";
				},

				tidy: function(txt) {
					txt=txt.replace(/\n|\r|\t/gi,"").replace(/^\s+/g,'');
					var l=txt.length,n=0,c,nc,i=0,fmt="",iq=false,ip=0;
					while(n<l) {
						c=txt[n++];
						nc=(n<l) ? txt[n] : '';
						if(c=='"') { fmt+=c; iq=!iq; }
						else if(iq) fmt+=c;
						else if(c=='[') {ip++; fmt+=c;}
						else if(c==']') {ip--; fmt+=c;}
						else if(ip)     fmt+=c;
						else if(c=='{') fmt+=c+newline(++i);
						else if(c==',') fmt+=c+newline(i);
						else if(c=='}') fmt+=newline(--i)+c;
						else fmt+=c;
					}
					return fmt;
				}
			}
		})(),

		error=function(){
			console.log(arguments.join(' '));
		},

		//PAGE STUFFS

		builder=(function(){
			var
			val=function(id,val){
				var o=_('#'+id);
				if(!o) console.log(id,"not found!");
				if(val!==undefined) o.value=val;
				return o.value;
			},
			isEmpty=function(o){
				for(var i in o) return false;
				return true;
			},
			values=function(str){
				var n,s=str.split(/\s*,\s*/),i,v,k;
				if(/:/.test(str)){
					n={};
					for(i=0;i<s.length;i++){
						if(s[i].match(/^(.+)\:(.+)$/)){
							k=RegExp.$1;
							v=RegExp.$2;
						} else {
							k=i;
							v=s[i];
						}
						v=v==""||v=="null"?null:parseFloat(v);
						n[k]=v;
					}
				} else {
					n=[];
					for(i=0;i<s.length;i++){
						v=s[i]==""||s[i]=="null"?null:parseFloat(s[i]);
						n.push(v);
					}
				}
				return n;
			},
			nswitch=0,
			bgswitch=function(cid,dft){
				var tgt=_('#'+cid),n=nswitch++,d=document.createElement('div');
				if(!dft) dft='none';
				d.className='bgswitch';
				['white','black','none'].forEach(function(c){
					var r=document.createElement('input');
					r.setAttribute('type','radio');
					r.setAttribute('name','bgswitch'+n);
					r.className='bg'+c;
					r.title="background "+c;
					if(c==dft) r.checked=true;
					r.onclick=function(){
						if(tgt.firstChild) tgt.firstChild.className='bg'+c;
					};
					d.appendChild(r);
				});
				if(tgt.firstChild) tgt.firstChild.className='bg'+dft;
				tgt.parentNode.getElementsByTagName('h2')[0].appendChild(d);
			},
			getlst=function(lst,pfx,h){
				var v;
				if(!h) h={};
				if(typeof(lst)=="string") lst=lst.split(' ');
				lst.forEach(function(l){
					if((v=val((pfx||'')+l)).length)
						if(/^(x|y|radius|radiuspoint|marks|linewidth|width|height|barspace|anim)$/.test(l))
							h[l]=parseInt(v,10);
						else if(/^(opacity)$/.test(l))
							h[l]=parseFloat(v);
						else if(/^(margins)$/.test(l))
							h[l]=values(v);
						else
							h[l]=v;
				});
				return h;
			},
			setlst=function(lst,pfx,h){
				var v;
				if(h){
					if(typeof(lst)=="string") lst=lst.split(' ');
					lst.forEach(function(l){
						if(l in h)
							val(
								(pfx||'')+l,
								(l[h] instanceof Array) ? h[l].join(',') : h[l]
							);
					});
				}
				return h;
			},
			save=function(){
				var o={container:'plot'},v,w,i,d=[],z;
				//get datas
				for(i=0;_('#data'+i);i++)
					if((w=val('data'+i)).length) {
						z={};
						if((v=val('title'+i)).length) z.title=v;
						if((v=val('color'+i)).length) z.color=v;
						z.values=values(w);
						d.push(z);
					}
				if(d.length) o.datas=d;
				//get title
				if((v=val('titletext')).length) {
					o.title=getlst('font color x y z shadow','title');
					o.title.text=v;
				}
				//get grid
				z={};
				getlst('color linewidth','grid',z);
				if((v=val('gridy')).length) z.y=/none|false/.test(v)?w:values(v);
				if((v=val('gridx')).length) z.x=v;
				if(!isEmpty(z)) o.grid=z;
				//get labels
				if((v=val('labelx')).length+(w=val('labely')).length) {
					o.labels=getlst('font color marks shadow ypos','label');
					if(v.length) o.labels.x=v=='auto'?v:parseInt(v,10);
					if(w.length) o.labels.y=values(w);
				}
				//get render
				getlst('width height mode fill opacity margins background linewidth linejoin radiuspoint anim','',o);
				if(/chart/.test(o.mode)) {
					_('#barspace').removeAttribute('disabled');
					getlst('barspace','',o);
				} else
					_('#barspace').setAttribute('disabled','disabled');
				z=getlst('top bottom','scale');
				if(z.top || z.bottom) o.scale = z;
				//get mouseover
				if(_('#mouseover').checked) {
					var m=getlst('radius linewidth circle font color border border2 bullet axis text shadow shadowbox','mo'),
					    h=getlst('text font color shadow','head');
					if(_('#mosort').checked) m.sort=true;
					if(!isEmpty(h)) m.header=h;
					if(!isEmpty(m)) o.mouseover=m;
				} else
					o.mouseover=false;
				//get legends
				if(_('#legends').checked) {
					var m=getlst('layout x y font background color border border2 shadow shadowbox','leg');
					if(!isEmpty(m)) o.legends=m;
				} else
					o.legends=false;

				//let's show
				var plot=_('#plot'),bg=plot.firstChild?plot.firstChild.className:'bgnone',ae=document.activeElement;
				_('#jsout',"plotter("+js.tidy(js.encode(o))+")");
				_('#plot','');
				if(ae && ae.id!="anim") delete o.anim;
				plotter(o);
				plot.firstChild.className=bg;
			},
			load=function(o){
				_('#fgen').reset();
				if(typeof(o)=="string") {
					o=o
						.replace(/[\n\r]+/g,'')
						.replace(/(^\s+|\s+$)/g,'')
						.replace(/^(plotter|harry)\s*\(/,'')
						.replace(/\s*\)$/,'');
					try{ o=JSON.parse(o) }
					catch(e){ error((e.name||'')+' '+(e.message||'unknown error')) }
				}
				if(o!==undefined) {
					var v,n,d,s,l;
					if(o.datas) {
						for(n in o.datas) {
							d=o.datas[n];
							s='';
							if(d.values instanceof Array){
								s=d.values.join(',');
							} else if (typeof(d.values)=='object') {
								l=[];
								for(var k in d.values) l.push(k+':'+d.values[k]);
								s=l.join(',');
							}
							val('data'+n,s);
							val('title'+n,d.title||'');
							val('color'+n,d.color||'');
						}
						setlst('text font color x y z shadow','title',o.title);
						setlst('x y color linewidth','grid',o.grid);
						setlst('x y color font color marks shadow ypos','label',o.labels);
						setlst('width height mode fill opacity margins background linewidth linejoin radiuspoint anim autoscale barspace','',o);
						_('#mouseover').checked=(o.mouseover==undefined || o.mouseover!==false);
						_('#mosort').checked=(o.mouseover && o.mouseover.sort);
						setlst('radius linewidth circle font color border border2 bullet axis text shadow shadowbox','mo',o.mouseover);
						setlst('text font color shadow','head',o.mouseover.header||{});
						_('#legends').checked=(o.legends==undefined || o.legends!==false);

						setlst('layout x y font background color border border2 shadow shadowbox','leg',o.legends);
					}
				}
				_('input.color').forEach(function(e){ setcolor(e.value,'#i'+e.id) });
				save();
			};
			return {
				load: load,
				save: save,
				bgswitch: bgswitch,
				loadpreset: function(n){
					load(PRESETS[n]);
					hash.set('preset',n);
					settab('generator');
				}
			};
		})(),

		settab=function(id,ps){
			if(ps && ps in PRESETS) builder.load(PRESETS[ps]);
			id=id||TABS[0];
			TABS.forEach(function(n){
				_('#'+n).className=id==n?'on':'';
				_('#but'+n).className=id==n?'on':'';
			});
			hash.set('tab',id);
		},

		setcolor=function(col,id){
			var v='#000000',o=_(id);
			col=col.replace(/(^\s+|\s+$)/,'');
			if(/^#[0-9A-F]{6}$/i.test(col))
				v=col;
			else if(/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i.test(col))
				v='#'+RegExp.$1+RegExp.$1+RegExp.$2+RegExp.$2+RegExp.$3+RegExp.$3;
			else if(/^rgba?\((\d+),(\d+),(\d+)(?:,[\d\.]+)?\)$/i.test(col))
				v='#'+('0'+RegExp.$1.toString(16)).substr(-2)+('0'+RegExp.$2.toString(16)).substr(-2)+('0'+RegExp.$3.toString(16)).substr(-2);
			if(o.value.toLowerCase()!=v.toLowerCase()) o.value=v;
		},

		animode="chart",
		anitimer=false,
		anidata=[],
		anicount=0,
		setupanim=function(){
			var w=window.innerWidth,c=_('#headanim'),p,nbd=w/4,
			fn=function(){
				// return Math.abs(Math.cos(++anicount/10)*100);
				return Math.floor(Math.random()*100);
			};
			if(anitimer!==false) clearInterval(anitimer);
			css(c,{width:w+'px'});
			c.setAttribute('width',w+'px');

			while(anidata.length>nbd) anidata.pop();
			while(anidata.length<nbd) anidata.push(fn());
			p=plotter({
				canvas:c,
				datas:[{color:"#5d5f55",values:anidata}],
				grid:{ y:"", x:"" },
				width:w,
				height:9,
				mode:animode,
				barspace: 1,
				mouseover:false
			});
			anitimer=setInterval(function(){
				anidata.shift();
				anidata.push(fn());
				p.clear().load([{color:"#5d5f55",values:anidata}]).draw();
			},40);
		};

		//INIT

		ready(function(){

			if(![].forEach) alert('this page requires a decent browser');

			console.log('load readme.md');
			ajax({
				url: "readme.md",
				datatype: 'text/plain',
				ok: function(d){
					console.log('readme.md loaded');
					_('#readme',md.html(d,2));
				}
			});

			console.log('load presets.js');
			ajax('presets.js',function(d){
				console.log('presets.js loaded');
				PRESETS={};
				var p=_('#samples'),n=0,s,t;
				p.innerHTML='';
				for(s in d) {
					append(p,'<header>'+s+'</header>');
					for(t in d[s]) {
						var j=d[s][t],bg=j.bg,h=
						'<div class="block">'+
							'<h2>'+t+'</h2>'+
							'<div id="box'+n+'" class="plotbox"></div>'+
							'<hr/>'+
							'<div class="src hide" id="src'+n+'">'+
								'<pre>plotter('+js.tidy(js.encode(j))+');</pre>'+
								'<hr/>'+
							'</div>'+
							'<div class="footer">'+
								'<input type="button" value="edit" onclick="builder.loadpreset(\''+t+'\',\''+t+'\')"/>'+
								'<input type="button" value="source" onclick="css(\'#src'+n+'\',\'*hide\')"/>'+
							'</div>'+
						'</div>';
						append(p,h);
						delete j.bg;
						PRESETS[t]=j;
						PRESETS[t].container="box"+n;
						plotter(PRESETS[t]);
						if(!j.background) builder.bgswitch('box'+n,bg);
						n++;
					}
				}
				console.log(n+' presets generated');
				if((t=hash.get('preset')) && t in PRESETS) builder.load(PRESETS[t]);
			});

			for(var i=0, l=document.getElementsByTagName("input"); i<l.length; ++i)
				if(/checkbox|text/.test(l[i].type))
					l[i].onclick=l[i].onkeyup=builder.save;
			for(var i=0, l=document.getElementsByTagName("select"); i<l.length; ++i)
				l[i].onclick=l[i].onkeyup=builder.save;

			_(".rnd").forEach(function(b){
				b.onclick=function(){
					var i,t=this.getAttribute('target'), d=[];
					for(i=0;i<MAXDATA;++i) d.push(Math.floor(Math.random()*100));
					_('#'+t).value=d.join(',');
					builder.save();
				};
			});
			_("#butreset").onclick=function(){
				_('#fgen').reset();
				hash.del('preset');
				builder.save();
			};
			_("#forkme").onclick=function(){
				document.location="https://github.com/nikopol/Harry-Plotter";
			}

			_('input.color').forEach(function(e){
				//e.onchange=
				//e.onkeyup
				e.oninput=function(){
					setcolor(this.value,'#i'+this.id);
					builder.save();
				 };
			});

			_('input[type=color]').forEach(function(e){
				e.onchange=function(){
					setcolor(this.value,'#'+this.id.substr(1));
					builder.save();
				 };
			});

			TABS.forEach(function(n){
				var id=n;
				_('#but'+n).onclick=function(){ settab(id) };
			});
			settab(hash.get("tab"));
			hash.onchange(function(){
				settab(hash.get("tab"),hash.get("preset"))
			});
			builder.bgswitch('plot');
			builder.save();

			hotkeys
				.add("alt+r",function(){ settab("readme") }, true)
				.add("alt+g",function(){ settab("generator") }, true)
				.add("alt+p",function(){ settab("presets") }, true);

			//setupanim();
			//window.onresize=setupanim;
		});
	</script>

</body>
</html>

